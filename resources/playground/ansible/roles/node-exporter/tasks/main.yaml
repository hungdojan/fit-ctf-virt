---
- name: Ensure podman is installed
  package:
    name:
      - podman
    state: present

- name: Enable user lingering for {{ user }}
  shell: "loginctl enable-linger {{ user }}"

- name: Create systemd user directory
  become: true
  become_user: "{{ user }}"
  file:
    path: "/home/{{ user }}/.config/containers/systemd"
    state: directory
    mode: 0755

- name: Deploy node-exporter quadlet
  become: true
  become_user: "{{ user }}"
  template:
    src: node-exporter.container
    dest: "/home/{{ user }}/.config/containers/systemd/node-exporter.container"
    mode: 0644

- name: Reload systemd user daemon
  become: true
  become_user: "{{ user }}"
  systemd:
    daemon_reload: true
    scope: user

- name: Start and enable node-exporter service
  become: true
  become_user: "{{ user }}"
  systemd:
    name: node-exporter.service
    state: started
    enabled: yes
    scope: user

- name: Wait for node-exporter to be available
  wait_for:
    host: localhost
    port: "{{ node_exporter_port | default(9100) }}"
    timeout: 30